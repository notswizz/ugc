rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function canAccessContract(contractId) {
      return isAuthenticated() &&
             firestore.exists(/databases/(default)/documents/contracts/$(contractId)) &&
             (firestore.get(/databases/(default)/documents/contracts/$(contractId)).data.brandId == request.auth.uid ||
              firestore.get(/databases/(default)/documents/contracts/$(contractId)).data.creatorId == request.auth.uid);
    }

    // User profile images and documents
    match /users/{userId}/{allPaths=**} {
      allow read: if true; // Public access for profile images
      allow write: if isOwner(userId);
      allow create: if isOwner(userId);
    }

    // Creator portfolio files
    match /creators/{creatorId}/portfolio/{allPaths=**} {
      allow read: if true; // Public portfolio access
      allow write: if isOwner(creatorId);
      allow create: if isOwner(creatorId);
    }

    // Campaign brand assets
    match /campaigns/{campaignId}/assets/{allPaths=**} {
      allow read: if firestore.exists(/databases/(default)/documents/campaigns/$(campaignId));
      allow write: if isAuthenticated() &&
                   firestore.exists(/databases/(default)/documents/campaigns/$(campaignId)) &&
                   firestore.get(/databases/(default)/documents/campaigns/$(campaignId)).data.brandId == request.auth.uid;
      allow create: if isAuthenticated() &&
                    firestore.exists(/databases/(default)/documents/campaigns/$(campaignId)) &&
                    firestore.get(/databases/(default)/documents/campaigns/$(campaignId)).data.brandId == request.auth.uid;
    }

    // Contract deliverables
    match /contracts/{contractId}/deliverables/{allPaths=**} {
      allow read: if canAccessContract(contractId);
      allow write: if canAccessContract(contractId);
      allow create: if canAccessContract(contractId);
    }

    // Dispute evidence
    match /disputes/{disputeId}/evidence/{allPaths=**} {
      allow read: if canAccessContract(firestore.get(/databases/(default)/documents/disputes/$(disputeId)).data.contractId);
      allow write: if canAccessContract(firestore.get(/databases/(default)/documents/disputes/$(disputeId)).data.contractId);
      allow create: if canAccessContract(firestore.get(/databases/(default)/documents/disputes/$(disputeId)).data.contractId);
    }

    // Admin files (admin only)
    match /admin/{allPaths=**} {
      allow read, write, create: if isAuthenticated() &&
                                 firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}